<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CentralComm</title>
  <link rel="stylesheet" href="../assets/styles/Dashboard-Styles.css">
  <link rel="stylesheet" href="Admin-style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="../auth/auth-check.js"></script>
</head>

<body>
  <div class="container">
    <nav>
      <ul>
        <li class="centralcomm">
          <div class="centralcomm-box"><a href="../admin/Admin-Section-Staff.html"><img
                src="../assets/icons&images/logo.png" alt="Logo Icon" class="logo-icon"> CentralComm</a></div>
        </li>
      </ul>
      <div class="menu-divider"></div>
      <ul class="top-menu">
        <li><a href="../admin/Admin-Section-Staff.html"><img src="../icons&images/house.svg" alt="Home Icon"
              class="icon"> Home</a></li>
        <li><a href="../admin/Admin-Dashboard.html"><img src="../icons&images/notif.svg" alt="Notifications Icon"
              class="icon"> Dashboard</a></li>
        <li><a href="../admin/Admin-Archived.html"><img src="../icons&images/archive.svg" alt="Archive Icon"
              class="icon"> Archived</a></li>
        <li><a href="../admin/admin-trash.html"><img src="../icons&images/trash.svg" alt="Notifications Icon"
              class="icon">Trash</a></li>
        <li><a href="../admin/Admin-History.html"><img src="../icons&images/notif.svg" alt="Notifications Icon"
              class="icon"> History</a></li>
        <li><a href="../auth/create-account.html"><img src="../icons&images/notif.svg" alt="Notifications Icon"
              class="icon"> Create Account</a></li>
      </ul>
      <ul id="logoutButton" class="bottom-menu">
        <li><a href="../auth/select-user-type.html"><img src="../icons&images/logout.svg" alt="Logout Icon"
              class="icon"> Log Out</a></li>
      </ul>
    </nav>

    <main>
      <div class="main-content">
        <div class="home-section">
          <header>
            <div class="greeting"><strong>Admin Section</strong></div>

            <div class="menu-divider2"></div>

            <div class="top-bar">
              <img src="../icons&images/bn-projects.png" alt="Home banner" class="banner">
            </div>
            <div class="drawer-template" id="drawer-template">
              <div id="drawer-sections-container"></div>
            </div>
          </header>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal for Add/Edit -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Add New Item</h2>
      <form id="itemForm">
        <input type="hidden" id="itemId">
        <input type="hidden" id="currentMonth">

        <!-- Update all required fields with required attribute and client-side validation -->
        <div class="form-group">
          <label for="ctrl_No">Control Number</label>
          <input type="text" id="ctrl_No" required readonly>
        </div>

        <div class="form-group">
          <label for="type">Type</label>
          <select id="type" required>
            <option value="">Select Type</option>
            <option value="Complaint">Complaint</option>
            <option value="Request">Request</option>
            <option value="Proposal">Proposal</option>
            <option value="Invitation">Invitation</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="time">Time Received</label>
          <input type="time" id="time" required>
        </div>

        <div class="form-group">
          <label for="date">Date Received</label>
          <input type="date" id="date" required>
        </div>

        <div class="form-group">
          <label for="from">From</label>
          <input type="text" id="from" required minlength="2">
        </div>

        <div class="form-group">
          <label for="office">Office</label>
          <input type="text" id="office" required minlength="2">
        </div>

        <div class="form-group">
          <label for="subject">Subject</label>
          <textarea id="subject" rows="3" required minlength="5"></textarea>
        </div>

        <!-- Optional fields (no required attribute) -->
        <div class="form-group">
          <label for="time2">Time Received </label>
          <input type="time" id="time2">
        </div>

        <div class="form-group">
          <label for="date2">Date Received </label>
          <input type="date" id="date2">
        </div>

        <div class="form-group">
          <label for="endorsed">Endorsed To</label>
          <select id="endorsed">
            <option value="">Select Office</option>
            <option value="Vice Mayor's Office">Vice Mayor's Office</option>
            <option value="Sangguniang Panlungsod">Sangguniang Panlungsod</option>
            <option value="CAO">CAO</option>
            <option value="CASSO">CASSO</option>
            <option value="CADMO">CADMO</option>
            <option value="CBO">CBO</option>
            <option value="CEPMO">CEPMO</option>
            <option value="CHRMO">CHRMO</option>
            <option value="CLO">CLO</option>
            <option value="CPDSO">CPDSO</option>
            <option value="CTO">CTO</option>
            <option value="GSO">GSO</option>
            <option value="CBAO">CBAO</option>
            <option value="CEO">CEO</option>
            <option value="CSWDO">CSWDO</option>
            <option value="HSO">HSO</option>
            <option value="LCR">LCR</option>
            <option value="CVAO">CVAO</option>
            <option value="DepEd">DepEd</option>
            <option value="COA">COA</option>
            <option value="MTCC">MTCC</option>
            <option value="RTCC">RTCC</option>
            <option value="Prosecutor's Office">Prosecutor's Office</option>
            <option value="PESO">PESO</option>
            <option value="PIO">PIO</option>
            <option value="PLD">PLD</option>
            <option value="PLEB">PLEB</option>
            <option value="POSD">POSD</option>
            <option value="SSD">SSD</option>
            <option value="PDAO">PDAO</option>
            <option value="MITD">MITD</option>
            <option value="CCTV/EWSS">CCTV/EWSS</option>
            <option value="CDRRMO">CDRRMO</option>
            <option value="LIBRARY">LIBRARY</option>
            <option value="PERSONAL STAFF">PERSONAL STAFF</option>
          </select>
        </div>

        <div class="form-group">
          <label for="remarks">Remarks</label>
          <textarea id="remarks" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="fC">File Code</label>
          <input type="text" id="fC">
        </div>

        <div class="form-group">
          <label for="status">Status</label>
          <select id="status">
            <option value="Pending">Pending</option>
            <option value="Processing">Processing</option>
            <option value="Completed">Completed</option>
            <option value="Archived">Archived</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
          <button type="button" class="btn btn-danger" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // Make months array globally accessible
    const months = [
      { name: 'January', tbodyId: 'tbody1' },
      { name: 'February', tbodyId: 'tbody2' },
      { name: 'March', tbodyId: 'tbody3' },
      { name: 'April', tbodyId: 'tbody4' },
      { name: 'May', tbodyId: 'tbody5' },
      { name: 'June', tbodyId: 'tbody6' },
      { name: 'July', tbodyId: 'tbody7' },
      { name: 'August', tbodyId: 'tbody8' },
      { name: 'September', tbodyId: 'tbody9' },
      { name: 'October', tbodyId: 'tbody10' },
      { name: 'November', tbodyId: 'tbody11' },
      { name: 'December', tbodyId: 'tbody12' },
    ];

    // Global function for toggling drawers
    function toggleDrawerState(month) {
      const drawer = document.getElementById(`drawer-${month}`);
      if (drawer.style.display === "none" || drawer.style.display === "") {
        // Close all other drawers first
        months.forEach(({ name }) => {
          if (name !== month) {
            const otherDrawer = document.getElementById(`drawer-${name}`);
            if (otherDrawer) otherDrawer.style.display = "none";
          }
        });
        // Open the selected drawer
        drawer.style.display = "block";
      } else {
        drawer.style.display = "none";
      }
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getDatabase, ref, child, onValue, get, set, update, remove, push } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCaSHRLbIRWW8COl5iwHb19dMDYYLJ2DIk",
      authDomain: "centralcomm-248a9.firebaseapp.com",
      databaseURL: "https://centralcomm-248a9-default-rtdb.firebaseio.com",
      projectId: "centralcomm-248a9",
      storageBucket: "centralcomm-248a9.firebasestorage.app",
      messagingSenderId: "796912003621",
      appId: "1:796912003621:web:0d6fd82e43399871a9edcc",
      measurementId: "G-CN0S9L5YV4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);


    let No = 0;
    let selectedMonth = '';
    let selectedItemId = '';

    // Modal elements
    const modal = document.getElementById('itemModal');
    const modalTitle = document.getElementById('modalTitle');
    const itemForm = document.getElementById('itemForm');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const closeBtn = document.querySelector('.close');

    // Form fields
    const itemIdField = document.getElementById('itemId');
    const currentMonthField = document.getElementById('currentMonth');
    const ctrlNoField = document.getElementById('ctrl_No');
    const typeField = document.getElementById('type');
    const timeField = document.getElementById('time');
    const dateField = document.getElementById('date');
    const fromField = document.getElementById('from');
    const officeField = document.getElementById('office');
    const subjectField = document.getElementById('subject');
    const time2Field = document.getElementById('time2');
    const date2Field = document.getElementById('date2');
    const endorsedField = document.getElementById('endorsed');
    const remarksField = document.getElementById('remarks');
    const fCField = document.getElementById('fC');
    const statusField = document.getElementById('status');



    // Modal event listeners
    closeBtn.onclick = function () {
      modal.style.display = "none";
    }

    cancelBtn.onclick = function () {
      modal.style.display = "none";
    }



    // Helper: pad numbers with leading zeros
    function padNumber(number, length) {
      return number.toString().padStart(length, '0');
    }

    // Modified control number generator
    function generateControlNumber(month, nextNumber) {
      const monthIndex = new Date(`${month} 1, 2000`).getMonth() + 1; // 1â€“12
      const paddedNumber = nextNumber.toString().padStart(6, '0');    // e.g., 000001
      const paddedMonth = monthIndex.toString().padStart(1, '0');     // e.g., 01
      return `${paddedNumber}${paddedMonth}`;                         // 00000101
    }

    // Get the next number robustly
    // Control number generator - now uses a single continuous sequence
    async function getNextControlNumber() {
      try {
        // Get all items from all months
        const allItems = [];
        for (const month of months) {
          const monthRef = ref(db, month.name);
          const snapshot = await get(monthRef);
          if (snapshot.exists()) {
            const items = snapshot.val();
            Object.values(items).forEach(item => allItems.push(item));
          }
        }

        if (allItems.length > 0) {
          // Get the highest control number from all months
          const maxNumber = Math.max(...allItems.map(item => {
            return parseInt(item.ctrl_No.substring(0, 6)); // Extract numeric part
          }));
          return maxNumber + 1;
        }
        return 1; // If no items exist yet
      } catch (error) {
        console.error("Error getting next control number:", error);
        return 1;
      }
    }

    // Mark required fields on modal open
    function markRequiredFields() {
      const requiredFields = [
        'ctrl_No', 'type', 'time', 'date',
        'from', 'office', 'subject'
      ];

      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.parentElement.classList.add('required');
        }
      });
    }

    // Modify openAddModal to use the above logic
    async function openAddModal(month) {
      selectedMonth = month;
      selectedItemId = '';

      // Reset form
      itemForm.reset();
      itemIdField.value = '';
      currentMonthField.value = month;
      modalTitle.textContent = 'Add New Item';

      // Set default values
      const now = new Date();
      timeField.value = now.toTimeString().substring(0, 5);
      dateField.value = now.toISOString().substring(0, 10);
      statusField.value = 'Pending';

      // Generate a temporary control number (will be finalized on save)
      try {
        const nextNumber = await getNextControlNumber(month);
        ctrlNoField.value = generateControlNumber(month, nextNumber);
      } catch (err) {
        console.error("Error generating control number:", err);
        ctrlNoField.value = generateControlNumber(month, 1);
      }

      modal.style.display = "block";
    }



    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    function AddItemToTableGeneric(tbody, data, month) {
      const trow = document.createElement("tr");
      trow.setAttribute('data-id', data.id);

      const tdNo = document.createElement('td');
      tdNo.innerHTML = ++No;
      trow.appendChild(tdNo);

      const fields = [
        'ctrl_No', 'type', 'time', 'date', 'from',
        'office', 'subject', 'time2', 'date2',
        'endorsed', 'remarks', 'fC', 'status'
      ];

      fields.forEach(field => {
        const td = document.createElement('td');
        td.innerHTML = data[field] || ''; // Handle undefined values
        trow.appendChild(td);
      });

      // Add action buttons
      const actionTd = document.createElement('td');

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-primary';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => editItem(month, data.id);
      actionTd.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger';
      deleteBtn.textContent = 'Trash';
      deleteBtn.onclick = () => deleteItem(month, data.id);
      actionTd.appendChild(deleteBtn);

      trow.appendChild(actionTd);

      tbody.appendChild(trow);
    }

    function AddAllItemsToTable(dataArray, tbodyId, month) {
      No = 0;
      const tbody = document.getElementById(tbodyId);
      if (tbody) {
        tbody.innerHTML = "";
        dataArray.forEach(data => AddItemToTableGeneric(tbody, data, month));
      }
    }

    function loadMonthData(monthName, tbodyId) {
      const monthRef = ref(db, monthName);

      onValue(monthRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          // Add id to each item
          const dataArray = Object.entries(data).map(([id, item]) => ({ ...item, id }));
          AddAllItemsToTable(dataArray, tbodyId, monthName);
          updateCategoryCounts(monthName, dataArray);
        } else {
          console.log(`No data found under /${monthName}`);
        }
      });
    }

    function updateCategoryCounts(month, data) {
      const complaints = data.filter(item => item.type === 'Complaint').length;
      const requests = data.filter(item => item.type === 'Request').length;
      const proposals = data.filter(item => item.type === 'Proposal').length;
      const invitations = data.filter(item => item.type === 'Invitation').length;
      const others = data.filter(item => !['Complaint', 'Request', 'Proposal', 'Invitation'].includes(item.type)).length;
      const total = data.length;

      const complaintsElement = document.getElementById(`complaints-count-${month}`);
      const requestsElement = document.getElementById(`requests-count-${month}`);
      const proposalsElement = document.getElementById(`proposals-count-${month}`);
      const invitationsElement = document.getElementById(`invitations-count-${month}`);
      const othersElement = document.getElementById(`others-count-${month}`);
      const totalElement = document.getElementById(`total-count-${month}`);

      if (complaintsElement) complaintsElement.textContent = complaints;
      if (requestsElement) requestsElement.textContent = requests;
      if (proposalsElement) proposalsElement.textContent = proposals;
      if (invitationsElement) invitationsElement.textContent = invitations;
      if (othersElement) othersElement.textContent = others;
      if (totalElement) totalElement.textContent = total;
    }

    // Search function
    function searchTable(month, tbodyId) {
      const input = document.getElementById(`search-${month}`).value.toLowerCase();
      const table = document.getElementById(tbodyId);
      const rows = table.getElementsByTagName('tr');
      const noResults = document.getElementById(`no-results-${month}`);
      let found = false;

      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let rowMatches = false;

        // Skip the first cell (index) and last cell (actions)
        for (let j = 1; j < cells.length - 1; j++) {
          const cellText = cells[j].textContent || cells[j].innerText;
          if (cellText.toLowerCase().indexOf(input) > -1) {
            rowMatches = true;
            break;
          }
        }

        if (rowMatches) {
          rows[i].style.display = "";
          found = true;
        } else {
          rows[i].style.display = "none";
        }
      }

      // Show/hide no results message
      if (found) {
        noResults.style.display = "none";
      } else {
        noResults.style.display = "block";
      }
    }

    // Make searchTable globally accessible
    window.searchTable = searchTable;



    function createDrawerSection(month, tbodyId) {
      const drawerHTML = `
    <div class="drawer-container">
      <button id="button-${month}" class="toggle-drawer-button" onclick="toggleDrawerState('${month}')">
        ${month}
      </button>
      <div id="drawer-${month}" class="drawer" style="display: none;">
        <div class="editable-box">
          <span id="editable-text-${month}" class="editable-text">${month}</span>
        </div>

        <div class="categories-container">
          <div class="categories">
            <div class="category-box">
              <h3>Complaints</h3>
              <div class="count" id="complaints-count-${month}">0</div>
            </div>
            <div class="category-box">
              <h3>Requests</h3>
              <div class="count" id="requests-count-${month}">0</div>
            </div>
            <div class="category-box">
              <h3>Proposals</h3>
              <div class="count" id="proposals-count-${month}">0</div>
            </div>
            <div class="category-box">
              <h3>Invitations</h3>
              <div class="count" id="invitations-count-${month}">0</div>
            </div>
            <div class="category-box">
              <h3>Others</h3>
              <div class="count" id="others-count-${month}">0</div>
            </div>
          </div>
        </div>

        <!-- Add search section here -->
        <div class="search-container">
          <input type="text" class="search-input" id="search-${month}" placeholder="Search records..." 
                 oninput="searchTable('${month}', '${tbodyId}')">
          <button class="search-btn" onclick="searchTable('${month}', '${tbodyId}')">
            Search
          </button>
        </div>
        <div id="no-results-${month}" class="no-results">No matching records found</div>

        <div class="admin-list-container">
          <table class="admin-list">
            <thead>
              <tr>
                <th>#</th>
                <th>Ctrl No.</th>
                <th>Letter Type</th>
                <th>Time Received</th>
                <th>Date Received</th>
                <th>From</th>
                <th>Office</th>
                <th>Subject</th>
                <th>Time Received</th>
                <th>Date Received</th>
                <th>Endorsed To</th>
                <th>Remarks</th>
                <th>File Code</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="${tbodyId}"></tbody>
          </table>
        </div>
        <div class="action-buttons">
          <div class="total-count-container">
            <span class="total-count-label">Total Letters:</span>
            <span class="total-count" id="total-count-${month}">0</span>
          </div>
          <button class="action-btn btn-add" onclick="openAddModal('${month}')">
            <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Add New Item
          </button>
        </div>
      </div>
    </div>
  `;
      return drawerHTML;
    }
    function renderAllDrawers() {
      const container = document.getElementById('drawer-sections-container');
      if (container) {
        container.innerHTML = ''; // Clear existing content
        months.forEach(({ name, tbodyId }) => {
          container.innerHTML += createDrawerSection(name, tbodyId);
        });
      }
    }

    function getAllDataRealtime(month, addFunction) {
      const dbref = ref(db, month);
      onValue(dbref, snapshot => {
        const letters = [];
        snapshot.forEach(childSnapshot => {
          letters.push({ ...childSnapshot.val(), id: childSnapshot.key });
        });
        addFunction(letters, month);
      });
    }

    // Item CRUD operations
    function addItem(month, itemData) {
      const itemsRef = ref(db, `${month}`);
      const newItemRef = push(itemsRef);
      return set(newItemRef, itemData);
    }

    function updateItem(month, itemId, itemData) {
      const itemRef = ref(db, `${month}/${itemId}`);
      return update(itemRef, itemData);
    }



    // Modify the deleteItem function in your Admin-Section-Staff.html
    function deleteItem(month, itemId) {
      if (confirm('Are you sure you want to move this item to trash?')) {
        // Get reference to the item
        const itemRef = ref(db, `${month}/${itemId}`);

        // First get the item data
        get(itemRef).then((snapshot) => {
          if (snapshot.exists()) {
            const itemData = snapshot.val();

            // Add metadata about original location
            itemData.deletedAt = new Date().toISOString();
            itemData.originalMonth = month;

            // Create reference in trash
            const trashRef = ref(db, `trash/${itemId}`);

            // First save to trash
            return set(trashRef, itemData)
              .then(() => {
                // Only after successful save to trash, remove original
                return remove(itemRef);
              })
              .then(() => {
                alert('Item moved to trash successfully');
              });
          } else {
            alert('Item not found!');
          }
        }).catch((error) => {
          console.error("Error moving to trash:", error);
          alert('Error moving item to trash. Please try again.');
        });
      }
    }

    function editItem(month, itemId) {
      const itemRef = ref(db, `${month}/${itemId}`);
      get(itemRef).then((snapshot) => {
        if (snapshot.exists()) {
          const itemData = snapshot.val();
          openEditModal(month, itemId, itemData);
        } else {
          alert("Item not found!");
        }
      });
    }

    function openEditModal(month, itemId, itemData) {
      selectedMonth = month;
      selectedItemId = itemId;

      // Fill form with item data
      itemIdField.value = itemId;
      currentMonthField.value = month;
      modalTitle.textContent = 'Edit Item';

      ctrlNoField.value = itemData.ctrl_No || '';
      typeField.value = itemData.type || '';
      timeField.value = itemData.time || '';
      dateField.value = itemData.date || '';
      fromField.value = itemData.from || '';
      officeField.value = itemData.office || '';
      subjectField.value = itemData.subject || '';
      time2Field.value = itemData.time2 || '';
      date2Field.value = itemData.date2 || '';
      endorsedField.value = itemData.endorsed || '';
      remarksField.value = itemData.remarks || '';
      fCField.value = itemData.fC || '';
      statusField.value = itemData.status || 'Pending';

      modal.style.display = "block";
    }

    // Save button handler
    // Save button handler
    saveBtn.onclick = async function () {
      // Check form validity
      if (!itemForm.checkValidity()) {
        itemForm.reportValidity();
        return;
      }

      const itemData = {
        ctrl_No: ctrlNoField.value,
        type: typeField.value,
        time: timeField.value,
        date: dateField.value,
        from: fromField.value,
        office: officeField.value,
        subject: subjectField.value,
        time2: time2Field.value,
        date2: date2Field.value,
        endorsed: endorsedField.value,
        remarks: remarksField.value,
        fC: fCField.value,
        status: statusField.value
      };

      try {
        if (selectedItemId) {
          // Update existing item
          await updateItem(selectedMonth, selectedItemId, itemData);
          alert('Item updated successfully!');
        } else {
          // Add new item - no need to regenerate control number here
          await addItem(selectedMonth, itemData);
          alert('Item added successfully!');
        }
        modal.style.display = "none";
      } catch (error) {
        console.error('Error saving item:', error);
        alert('Error saving item. Please try again.');
      }
    };

    // Make openAddModal globally accessible
    window.openAddModal = openAddModal;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
      renderAllDrawers();

      // Load data for each month
      months.forEach(({ name, tbodyId }) => {
        loadMonthData(name, tbodyId);
        getAllDataRealtime(name, (data, month) => AddAllItemsToTable(data, tbodyId, month));
      });
    });
  </script>
</body>

</html>