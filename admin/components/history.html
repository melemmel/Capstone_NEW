<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>History & Audit Logs</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
    />
    <style>
      :root {
        --primary-green: #2e7d32;
        --secondary-green: #1b5e20;
        --light-green: #4caf50;
        --sidebar-bg: #1b5e20;
        --card-hover: #388e3c;
        --bg-light: #f8f9fa;
        --text-muted: #6c757d;
        --border-color: rgba(0, 0, 0, 0.1);
      }

      body {
        background-color: var(--bg-light);
        font-family: "Poppins", sans-serif;
        overflow-x: hidden;
      }

      .sidebar {
        min-height: 100vh;
        background-color: var(--sidebar-bg);
        color: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        position: fixed;
        width: 300px;
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.85);
        padding: 0.75rem 1.5rem;
        margin: 0.2rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
      }

      .sidebar .nav-link:hover {
        color: white;
        background-color: var(--light-green);
        transform: translateX(5px);
      }

      .sidebar .nav-link.active {
        color: white;
        background-color: var(--light-green);
        font-weight: 600;
      }

      .main-content {
        margin-left: 300px;
        padding: 2.5rem;
        transition: all 0.3s ease;
      }

      .header-section {
        background: linear-gradient(
          135deg,
          var(--primary-green),
          var(--secondary-green)
        );
        padding: 1.75rem;
        border-radius: 15px;
        color: white;
        margin-bottom: 2.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .log-item {
        border-left: 4px solid var(--primary-green);
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .log-item.create {
        border-left-color: #4caf50;
      }

      .log-item.update {
        border-left-color: #2196f3;
      }

      .log-item.delete {
        border-left-color: #f44336;
      }

      .log-time {
        font-size: 0.875rem;
        color: var(--text-muted);
      }

      .log-user {
        font-weight: 600;
        color: var(--primary-green);
      }

      .log-details {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }

      .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .table-responsive {
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        border-top: none;
      }

      .table td {
        vertical-align: middle;
      }

      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0 sidebar" id="sidebar">
          <div class="d-flex flex-column p-4">
            <a
              href="/"
              class="d-flex align-items-center mb-4 me-md-auto text-white text-decoration-none"
            >
              <i class="bi bi-shield-lock me-3"></i>
              <span class="fs-4">CentralComm</span>
            </a>
            <hr class="border-light opacity-50" />
            <ul class="nav nav-pills flex-column mb-auto">
              <li class="nav-item">
                <a href="template.html" class="nav-link">
                  <i class="bi bi-house-door me-2"></i>
                  Dashboard
                </a>
              </li>
              <li>
                <a href="#" class="nav-link">
                  <i class="bi bi-file-earmark-text me-2"></i>
                  Documents
                </a>
              </li>
              <li>
                <a href="#" class="nav-link">
                  <i class="bi bi-people me-2"></i>
                  Users
                </a>
              </li>
              <li>
                <a href="#" class="nav-link">
                  <i class="bi bi-archive me-2"></i>
                  Archives
                </a>
              </li>
              <li>
                <a href="history.html" class="nav-link active">
                  <i class="bi bi-clock-history me-2"></i>
                  History
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
          <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h1 class="h2 mb-1">History & Audit Logs</h1>
                <p class="mb-0 text-white-50">Track all system activities</p>
              </div>
              <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                  <button type="button" class="btn btn-sm btn-outline-light" id="exportLogs">
                    <i class="bi bi-download me-1"></i>Export
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="filter-section">
            <div class="row">
              <div class="col-md-3">
                <label for="dateFilter" class="form-label">Date Range</label>
                <select class="form-select" id="dateFilter">
                  <option value="all">All Time</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="actionFilter" class="form-label">Action Type</label>
                <select class="form-select" id="actionFilter">
                  <option value="all">All Actions</option>
                  <option value="create">Create</option>
                  <option value="update">Update</option>
                  <option value="delete">Delete</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="userFilter" class="form-label">User</label>
                <select class="form-select" id="userFilter">
                  <option value="all">All Users</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="searchFilter" class="form-label">Search</label>
                <input type="text" class="form-control" id="searchFilter" placeholder="Search logs...">
              </div>
            </div>
          </div>

          <!-- Logs Table -->
          <div class="table-responsive">
            <table class="table table-hover" id="logsTable">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Details</th>
                  <th>Control #</th>
                  <th>IP Address</th>
                </tr>
              </thead>
              <tbody id="logsTableBody">
                <!-- Logs will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCaSHRLbIRWW8COl5iwHb19dMDYYLJ2DIk",
        authDomain: "centralcomm-248a9.firebaseapp.com",
        databaseURL: "https://centralcomm-248a9-default-rtdb.firebaseio.com",
        projectId: "centralcomm-248a9",
        storageBucket: "centralcomm-248a9.firebasestorage.app",
        messagingSenderId: "796912003621",
        appId: "1:796912003621:web:0d6fd82e43399871a9edcc",
        measurementId: "G-CN0S9L5YV4"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const database = firebase.database();
      const logsRef = database.ref('logs');
      const usersRef = database.ref('users');

      // Initialize DataTable
      let logsTable;
      $(document).ready(function() {
        logsTable = $('#logsTable').DataTable({
          order: [[0, 'desc']],
          pageLength: 25,
          language: {
            search: "Search logs:",
            lengthMenu: "Show _MENU_ entries per page",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "No entries found",
            infoFiltered: "(filtered from _MAX_ total entries)"
          }
        });

        // Load users for filter
        loadUsers();
        // Load logs
        loadLogs();
      });

      // Function to load users for filter
      function loadUsers() {
        usersRef.once('value', (snapshot) => {
          const users = snapshot.val();
          const userFilter = document.getElementById('userFilter');
          
          if (users) {
            Object.entries(users).forEach(([_, user]) => {
              const option = document.createElement('option');
              option.value = user.email;
              option.textContent = user.name || user.email;
              userFilter.appendChild(option);
            });
          }
        });
      }

      // Function to load logs
      function loadLogs() {
        logsRef.on('value', (snapshot) => {
          const logs = snapshot.val();
          const logsTableBody = document.getElementById('logsTableBody');
          logsTableBody.innerHTML = '';

          if (logs) {
            Object.entries(logs).forEach(([_, log]) => {
              const row = document.createElement('tr');
              row.className = `log-item ${log.action}`;
              row.innerHTML = `
                <td>${formatDateTime(log.timestamp)}</td>
                <td>${log.user}</td>
                <td><span class="badge bg-${getActionColor(log.action)}">${log.action}</span></td>
                <td>${log.details}</td>
                <td>${log.controlNumber || '-'}</td>
                <td>${log.ipAddress || '-'}</td>
              `;
              logsTableBody.appendChild(row);
            });
          }
        });
      }

      // Function to format date and time
      function formatDateTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }

      // Function to get action color
      function getActionColor(action) {
        switch(action) {
          case 'create': return 'success';
          case 'update': return 'primary';
          case 'delete': return 'danger';
          default: return 'secondary';
        }
      }

      // Event listeners for filters
      document.getElementById('dateFilter').addEventListener('change', filterLogs);
      document.getElementById('actionFilter').addEventListener('change', filterLogs);
      document.getElementById('userFilter').addEventListener('change', filterLogs);
      document.getElementById('searchFilter').addEventListener('keyup', filterLogs);

      // Function to filter logs
      function filterLogs() {
        const dateFilter = document.getElementById('dateFilter').value;
        const actionFilter = document.getElementById('actionFilter').value;
        const userFilter = document.getElementById('userFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

        logsTable.search(searchFilter).draw();
        
        // Additional filtering logic can be added here
      }

      // Export logs functionality
      document.getElementById('exportLogs').addEventListener('click', function() {
        // Get current filters
        const dateFilter = document.getElementById('dateFilter').value;
        const actionFilter = document.getElementById('actionFilter').value;
        const userFilter = document.getElementById('userFilter').value;
        
        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Timestamp,User,Action,Details,Control Number,IP Address\n";

        // Get filtered logs
        logsRef.once('value', (snapshot) => {
          const logs = snapshot.val();
          if (logs) {
            Object.entries(logs).forEach(([_, log]) => {
              // Apply filters
              if ((dateFilter === 'all' || isInDateRange(log.timestamp, dateFilter)) &&
                  (actionFilter === 'all' || log.action === actionFilter) &&
                  (userFilter === 'all' || log.user === userFilter)) {
                csvContent += `${formatDateTime(log.timestamp)},${log.user},${log.action},${log.details},${log.controlNumber || '-'},${log.ipAddress || '-'}\n`;
              }
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `audit_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        });
      });

      // Function to check if timestamp is in date range
      function isInDateRange(timestamp, range) {
        const date = new Date(timestamp);
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        switch(range) {
          case 'today':
            return date >= startOfDay;
          case 'week':
            return date >= startOfWeek;
          case 'month':
            return date >= startOfMonth;
          default:
            return true;
        }
      }
    </script>
  </body>
</html>
